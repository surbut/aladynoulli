all_risks <- data.frame(
cox_basic = rep(NA, N),
cox_aladyn = rep(NA, N),
cox_combined = rep(NA, N)
)
# Create survival data
df <- data.frame(
id = 1:N,
time = as.numeric(event_times),
event = event,
sex = sex,
smoke = smoke,
aladyn_pred = aladyn_pred
)
# Get indices of people still at risk
at_risk_idx <- which(df$time > from_age)
if(length(at_risk_idx) > 0) {
df_risk <- df[at_risk_idx,]
df_risk$time <- df_risk$time - from_age
# Fit three models
cox_basic <- coxph(Surv(time, event) ~ sex + smoke, data=df_risk)
cox_aladyn <- coxph(Surv(time, event) ~ aladyn_pred, data=df_risk)
cox_combined <- coxph(Surv(time, event) ~ sex + smoke + aladyn_pred, data=df_risk)
# Get risks for each model
all_risks$cox_basic[at_risk_idx] <- 1 - exp(-predict(cox_basic, type="expected"))
all_risks$cox_aladyn[at_risk_idx] <- 1 - exp(-predict(cox_aladyn, type="expected"))
all_risks$cox_combined[at_risk_idx] <- 1 - exp(-predict(cox_combined, type="expected"))
}
return(all_risks)
}
# Calculate risks for all models at each age
all_risks <- list()
for(age in ages) {
time_idx <- age - 29
all_risks[[as.character(age)]] <- array(NA, dim=c(N, D, 3))  # 3 models
for(d in 1:D) {
risks <- fit_cox_models(
event_times = model_data$event_times[,d]+1,
event = rowSums(Y[,d,time_idx:T]),
sex = model_data$metadata$sex,
smoke = model_data$metadata$smoke,
aladyn_pred = aladyn_risks[[as.character(age)]][,d],
from_age = time_idx
)
all_risks[[as.character(age)]][,d,] <- as.matrix(risks)
}
}
# Compare performance
results <- data.frame()
for(age in ages) {
for(d in 1:D) {
# Get predictions from all models
basic_pred <- all_risks[[as.character(age)]][,d,1]
aladyn_pred <- all_risks[[as.character(age)]][,d,2]
combined_pred <- all_risks[[as.character(age)]][,d,3]
# Get actual outcomes
time_idx <- age - 29
true_outcome <- rowSums(Y[,d,time_idx:T]) > 0
# Calculate AUCs
valid_idx <- !is.na(basic_pred)
if(sum(valid_idx) > 0 &&
sum(true_outcome[valid_idx]) > 0 &&
sum(!true_outcome[valid_idx]) > 0) {
auc_basic <- auc(true_outcome[valid_idx], basic_pred[valid_idx])
auc_aladyn <- auc(true_outcome[valid_idx], aladyn_pred[valid_idx])
auc_combined <- auc(true_outcome[valid_idx], combined_pred[valid_idx])
results <- rbind(results, data.frame(
age = age,
disease = d,
disease_name = disease_name_list[d],
auc_basic = auc_basic,
auc_aladyn = auc_aladyn,
auc_combined = auc_combined,
n_at_risk = sum(valid_idx),
n_events = sum(true_outcome[valid_idx])
))
}
}
}
head(results)
plot(age,results$auc_basic)
plot(results$age,results$auc_basic)
plot(results$age,results$auc_basic)
plot(auc_basic,auc_aladyn)
plot(auc_basic,auc_aladyn)
plot(auc_basic,auc_aladyn)
plot(results$auc_basic,results$auc_aladyn)
plot(results$auc_basic,results$auc_combined)
apply(results[,c("auc_basic","auc_aladyn","auc_combined")])
sum=results[,c("auc_basic","auc_aladyn","auc_combined")]
means=apply(sum,2,mean)
sd=apply(sum,2,sd)
barplot(means)
# Compare performance
results <- data.frame()
for(age in ages) {
for(d in 1:D) {
# Get predictions from all models
basic_pred <- all_risks[[as.character(age)]][,d,1]
aladyn_pred <- all_risks[[as.character(age)]][,d,2]
combined_pred <- all_risks[[as.character(age)]][,d,3]
# Get actual outcomes
time_idx <- age - 29
true_outcome <- rowSums(Y[,d,time_idx:T]) > 0
# Calculate AUCs
valid_idx <- !is.na(basic_pred)
if(sum(valid_idx) > 0 &&
sum(true_outcome[valid_idx]) > 0 &&
sum(!true_outcome[valid_idx]) > 0) {
auc_basic <- auc(true_outcome[valid_idx], basic_pred[valid_idx])
auc_aladyn <- auc(true_outcome[valid_idx], aladyn_pred[valid_idx])
auc_combined <- auc(true_outcome[valid_idx], combined_pred[valid_idx])
results <- rbind(results, data.frame(
age = age,
disease = d,
disease_name = disease_name_list[d],
auc_basic = auc_basic,
auc_aladyn = auc_aladyn,
auc_combined = auc_combined,
n_at_risk = sum(valid_idx),
n_events = sum(true_outcome[valid_idx])
))
}
}
}
# Calculate means and SDs
sum <- results[,c("auc_basic","auc_aladyn","auc_combined")]
means <- apply(sum,2,mean)
sds <- apply(sum,2,sd)
# Create nicer plot
barplot(means,
ylim=c(0,1),
col=c("lightgray","skyblue","lightgreen"),
names.arg=c("Basic\n(sex+smoke)", "Aladyn", "Combined"),
main="Average AUC Across All Diseases",
ylab="AUC")
# Add error bars
arrows(seq(0.7,2.7,1), means-sds, seq(0.7,2.7,1), means+sds,
code=3, angle=90, length=0.05)
# Add numeric values
text(seq(0.7,2.7,1), means+0.05,
sprintf("%.3f", means))
# Add legend
legend("topright",
c(paste("n diseases =", nrow(results)),
paste("mean follow-up =", mean(results$n_at_risk))),
bty="n")
# Create nicer plot
barplot(means,
ylim=c(0,1),
col=c("lightgray","skyblue","lightgreen"),
names.arg=c("Basic\n(sex+smoke)", "Aladyn", "Combined"),
main="Average AUC Across All Diseases",
ylab="AUC")
# Add error bars
arrows(seq(0.7,2.7,1), means-sds, seq(0.7,2.7,1), means+sds,
code=3, angle=90, length=0.05)
# Add numeric values
text(seq(0.7,2.7,1), means+0.01,
sprintf("%.3f", means))
# Add legend
legend("bottomleft",
c(paste("n diseases =", nrow(results)),
paste("mean follow-up =", mean(results$n_at_risk))),
bty="n")
# Add legend
legend("bottomleft",
c(paste("n diseases =", nrow(results)),
paste("mean follow-up =", round(mean(results$n_at_risk),1)),
bty="n")
# Create nicer plot
barplot(means,
# Create nicer plot
barplot(means,
ylim=c(0,1),
col=c("lightgray","skyblue","lightgreen"),
names.arg=c("Basic\n(sex+smoke)", "Aladynoulli", "Combined"),
main="Average AUC Across All Diseases",
ylab="AUC")
# Add error bars
arrows(seq(0.7,2.7,1), means-sds, seq(0.7,2.7,1), means+sds,
code=3, angle=90, length=0.05)
# Add numeric values
text(seq(0.7,2.7,1), means+0.01,
sprintf("%.3f", means))
# Add legend
legend("bottomleft",
c(paste("n diseases =", nrow(results)),
paste("mean follow-up =", round(mean(results$n_at_risk),1)),
bty="n")
# Add legend
legend("bottomleft",
# Create nicer plot
barplot(means,
ylim=c(0,1),
col=c("lightgray","skyblue","lightgreen"),
names.arg=c("Basic\n(sex+smoke)", "Aladynoulli", "Combined"),
main="Average AUC Across All Diseases",
ylab="AUC")
# Add error bars
arrows(seq(0.7,2.7,1), means-sds, seq(0.7,2.7,1), means+sds,
code=3, angle=90, length=0.05)
# Add numeric values
text(seq(0.7,2.7,1), means+0.01,
sprintf("%.3f", means))
# Add legend
legend("bottomleft",
c(paste("n diseases =", nrow(results/51)),
paste("mean follow-up =", round(mean(results$n_at_risk),1)),
bty="n")
)
dim(results)
dim(results/length(ages))
dim(results)[1]/length(ages))
dim(results)[1]/length(ages)
# Add legend
legend("bottomleft",
c(paste("n diseases = 348"),
paste("mean number of individuals at risk =", round(mean(results$n_at_risk),1)),
bty="n"))
# Create nicer plot
barplot(means,
ylim=c(0,1),
col=c("lightgray","skyblue","lightgreen"),
names.arg=c("Basic\n(sex+smoke)", "Aladynoulli", "Combined"),
main="Average AUC Across All Diseases",
ylab="AUC")
# Add error bars
arrows(seq(0.7,2.7,1), means-sds, seq(0.7,2.7,1), means+sds,
code=3, angle=90, length=0.05)
# Add numeric values
text(seq(0.7,2.7,1), means+0.01,
sprintf("%.3f", means))
# Add legend
legend("bottomleft",
c(paste("n diseases = 348"),
paste("mean number of individuals at risk =", round(mean(results$n_at_risk),1)),
bty="n"))
# Create nicer plot
barplot(means,
ylim=c(0,1),
col=c("lightgray","skyblue","lightgreen"),
names.arg=c("Basic\n(sex+smoke)", "Aladynoulli", "Combined"),
main="Average AUC Across All Diseases",
ylab="AUC")
# Add error bars
arrows(seq(0.7,2.7,1), means-sds, seq(0.7,2.7,1), means+sds,
code=3, angle=90, length=0.05)
# Add numeric values
text(seq(0.7,2.7,1), means+0.05,
sprintf("%.3f", means))
# Add legend
legend("bottomleft",
c(paste("n diseases = 348"),
paste("mean number of individuals at risk =", round(mean(results$n_at_risk),1)),
bty="n"))
# Add legend
legend("bottomcenter",
c(paste("n diseases = 348"),
paste("mean number of individuals at risk =", round(mean(results$n_at_risk),1)),
bty="n"))
# Create nicer plot
barplot(means,
ylim=c(0,1),
col=c("lightgray","skyblue","lightgreen"),
names.arg=c("Basic\n(sex+smoke)", "Aladynoulli", "Combined"),
main="Average AUC Across All Diseases",
ylab="AUC")
# Add error bars
arrows(seq(0.7,2.7,1), means-sds, seq(0.7,2.7,1), means+sds,
code=3, angle=90, length=0.05)
# Add numeric values
text(seq(0.7,2.7,1), means+0.05,
sprintf("%.3f", means))
# Add legend
legend("bottomcenter",
c(paste("n diseases = 348"),
paste("mean number of individuals at risk =", round(mean(results$n_at_risk),1)),
bty="n"))
# Create nicer plot
barplot(means,
ylim=c(0,1),
col=c("lightgray","skyblue","lightgreen"),
names.arg=c("Basic\n(sex+smoke)", "Aladynoulli", "Combined"),
main="Average AUC Across All Diseases",
ylab="AUC")
# Add error bars
arrows(seq(0.7,2.7,1), means-sds, seq(0.7,2.7,1), means+sds,
code=3, angle=90, length=0.05)
# Add numeric values
text(seq(0.7,2.7,1), means+0.05,
sprintf("%.3f", means))
# Add legend
legend("bottom",
c(paste("n diseases = 348"),
paste("mean number of individuals at risk =", round(mean(results$n_at_risk),1)),
bty="n"))
# Add legend
legend("bottom",
c(paste("n diseases = 348"),
paste("mean number of individuals at risk =", round(mean(results$n_at_risk),1)),
bty="n"))
# Create nicer plot
barplot(means,
ylim=c(0,1),
col=c("lightgray","skyblue","lightgreen"),
names.arg=c("Basic\n(sex+smoke)", "Aladynoulli", "Combined"),
main="Average AUC Across All Diseases",
ylab="AUC")
# Add error bars
arrows(seq(0.7,2.7,1), means-sds, seq(0.7,2.7,1), means+sds,
code=3, angle=90, length=0.05)
# Add numeric values
text(seq(0.7,2.7,1), means+0.05,
sprintf("%.3f", means))
means
dframe=data.frame(means)
head(dframe)
ggplot(dframe,aes(x=means))+geom_bar(stat="identity")
# Create nicer plot
barplot(means,
ylim=c(0,1),
col=c("lightgray","skyblue","lightgreen"),
names.arg=c("Basic\n(sex+smoke)", "Aladynoulli", "Combined"),
main="Average AUC Across All Diseases",
ylab="AUC")
# Add error bars
arrows(seq(0.7,2.7,1), means-sds, seq(0.7,2.7,1), means+sds,
code=3, angle=90, length=0.05)
# Add numeric values
text(seq(0.7,2.7,1), means+0.05,
sprintf("%.3f", means))
# Add legend
legend("bottom",
c(paste("n diseases = 348"),
paste("mean number of individuals at risk =", round(mean(results$n_at_risk),1)),
bty="n"))
# Create nicer plot
barplot(means,
ylim=c(0,1),
col=c("lightgray","skyblue","lightgreen"),
names.arg=c("Basic\n(sex+smoke)", "Aladynoulli", "Combined"),
ylab="AUC Across all Diseases")
# Add error bars
arrows(seq(0.7,2.7,1), means-sds, seq(0.7,2.7,1), means+sds,
code=3, angle=90, length=0.05)
# Add numeric values
text(seq(0.7,2.7,1), means+0.05,
sprintf("%.3f", means))
# Add legend
legend("bottom",
c(paste("n diseases = 348"),
paste("mean number of individuals at risk =", round(mean(results$n_at_risk),1)),
bty="n"))
# Add legend
legend("bottomleft",
c(paste("n diseases = 348"),
paste("mean number of individuals at risk =", round(mean(results$n_at_risk),1)),
bty="n"))
# Create nicer plot
barplot(means,
ylim=c(0,1),
col=c("lightgray","skyblue","lightgreen"),
names.arg=c("Basic\n(sex+smoke)", "Aladynoulli", "Combined"),
ylab="AUC Across all Diseases")
# Add error bars
arrows(seq(0.7,2.7,1), means-sds, seq(0.7,2.7,1), means+sds,
code=3, angle=90, length=0.05)
# Add numeric values
text(seq(0.7,2.7,1), means+0.05,
sprintf("%.3f", means))
# Add legend
legend("bottomleft",
c(paste("n diseases = 348"),
paste("mean number of individuals at risk over time =", round(mean(results$n_at_risk),1)),
bty="n"))
# Create nicer plot
barplot(means,
ylim=c(0,1),
col=c("lightgray","skyblue","lightgreen"),
names.arg=c("Basic\n(sex+smoke)", "Aladynoulli", "Combined"),
ylab="AUC Across all Diseases of remaining risk")
# Add error bars
arrows(seq(0.7,2.7,1), means-sds, seq(0.7,2.7,1), means+sds,
code=3, angle=90, length=0.05)
# Add numeric values
text(seq(0.7,2.7,1), means+0.05,
sprintf("%.3f", means))
# Add legend
legend("bottomleft",
c(paste("n diseases = 348"),
paste("mean number of individuals at risk over time =", round(mean(results$n_at_risk),1)),
bty="n"))
# Create nicer plot
barplot(means,
ylim=c(0,1.3),
col=c("lightgray","skyblue","lightgreen"),
names.arg=c("Basic\n(sex+smoke)", "Aladynoulli", "Combined"),
ylab="AUC Across all Diseases of remaining risk")
# Add error bars
arrows(seq(0.7,2.7,1), means-sds, seq(0.7,2.7,1), means+sds,
code=3, angle=90, length=0.05)
# Add numeric values
text(seq(0.7,2.7,1), means+0.05,
sprintf("%.3f", means))
# Add legend
legend("bottomleft",
c(paste("n diseases = 348"),
paste("mean number of individuals at risk over time =", round(mean(results$n_at_risk),1)),
bty="n"))
# Create nicer plot
barplot(means,
ylim=c(0,1.1),
col=c("lightgray","skyblue","lightgreen"),
names.arg=c("Basic\n(sex+smoke)", "Aladynoulli", "Combined"),
ylab="AUC Across all Diseases of remaining risk")
# Add error bars
arrows(seq(0.7,2.7,1), means-sds, seq(0.7,2.7,1), means+sds,
code=3, angle=90, length=0.05)
# Add numeric values
text(seq(0.7,2.7,1), means+0.05,
sprintf("%.3f", means))
# Add legend
legend("bottomleft",
c(paste("n diseases = 348"),
paste("mean number of individuals at risk over time =", round(mean(results$n_at_risk),1)),
bty="n"))
# Add legend
legend("bottomleft",
c(paste("n diseases = 348"),
paste("mean number at risk=", round(mean(results$n_at_risk),1)),
bty="n"))
# Create nicer plot
barplot(means,
ylim=c(0,1.1),
col=c("lightgray","skyblue","lightgreen"),
names.arg=c("Basic\n(sex+smoke)", "Aladynoulli", "Combined"),
ylab="AUC Across all Diseases of remaining risk")
# Add error bars
arrows(seq(0.7,2.7,1), means-sds, seq(0.7,2.7,1), means+sds,
code=3, angle=90, length=0.05)
# Add numeric values
text(seq(0.7,2.7,1), means+0.05,
sprintf("%.3f", means))
# Add legend
legend("bottomleft",
c(paste("n diseases = 348"),
paste("mean number at risk=", round(mean(results$n_at_risk),1)),
bty="n"))
groups=readRDS("~/Dropbox (Personal)/groups.rds")
groups=readRDS("~/Dropbox (Personal)/disease_groups.rds")
results$auc_improvement <- results$auc_combined - results$auc_basic
results$rel_improvement <- (results$auc_combined - results$auc_basic)/results$auc_basic
# Look at where Aladyn helps most
top_improvements <- results[order(-results$auc_improvement),]
head(top_improvements[,c("disease_name", "age", "auc_basic", "auc_combined",
"auc_improvement", "n_events")])
# 2. Disease-group specific analysis
results_by_group <- merge(results, groups[,c("phenotype","exclude_name")],
by.x="disease_name", by.y="phenotype")
boxplot(auc_improvement ~ exclude_name, data=results_by_group,
las=2, main="Improvement by Disease Group")
# 3. Age-specific patterns
boxplot(auc_improvement ~ age, data=results,
main="Improvement by Age")
ggplot(dframe,aes(x=means))+geom_bar(stat="identity")
groups=readRDS("~/Dropbox (Personal)/disease_groups.rds")
results$auc_improvement <- results$auc_aladyn - results$auc_basic
results$rel_improvement <- (results$auc_aladyn - results$auc_basic)/results$auc_basic
# Look at where Aladyn helps most
top_improvements <- results[order(-results$auc_improvement),]
head(top_improvements[,c("disease_name", "age", "auc_basic", "auc_combined",
"auc_improvement", "n_events")])
# 2. Disease-group specific analysis
results_by_group <- merge(results, groups[,c("phenotype","exclude_name")],
by.x="disease_name", by.y="phenotype")
boxplot(auc_improvement ~ exclude_name, data=results_by_group,
las=2, main="Improvement by Disease Group")
# 3. Age-specific patterns
boxplot(auc_improvement ~ age, data=results,
main="Improvement by Age")
boxplot(auc_improvement ~ exclude_name, data=results_by_group,
las=2, main="Improvement by Disease Group",cex.axis=0.7,cex.lab=0.7)
boxplot(auc_improvement ~ exclude_name, data=results_by_group,
las=2, main="Improvement by Disease Group",cex.axis=0.7,cex.lab=0.7,x="",y="AUC Improvement",main="")
boxplot(auc_improvement ~ exclude_name, data=results_by_group,
las=2, main="Improvement by Disease Group",cex.axis=0.7,cex.lab=0.7,x="",y="AUC Improvement",main="")
boxplot(auc_improvement ~ exclude_name, data=results_by_group,
las=2, cex.axis=0.7,cex.lab=0.7,xlab="",ylab="AUC Improvement",main="")
ggplot(auc_improvement,aes(x=exclude_name,y=value))+geom_box()
head(results_by_group)
ggplot(results_by_group,aes(x=exclude_name,y=auc_improvement,fill=exclude_name))+geom_boxplot()
ggplot(results_by_group,aes(x=exclude_name,y=auc_improvement,fill=exclude_name))+geom_boxplot()+theme_classic()+scale_fill_aaas()
ggplot(results_by_group,aes(x=exclude_name,y=auc_improvement,fill=exclude_name))+geom_boxplot()+theme_classic()+scale_fill_science()
ggplot(results_by_group,aes(x=exclude_name,y=auc_improvement,fill=exclude_name))+geom_boxplot()+theme_classic()+scale_fill_futurama()
ggplot(results_by_group,aes(x=exclude_name,y=auc_improvement,fill=exclude_name))+geom_boxplot()+theme_classic()+scale_fill_npg()
ggplot(results_by_group,aes(x=exclude_name,y=auc_improvement,fill=exclude_name))+geom_boxplot()+theme_classic()+scale_fill_cosmic()
ggplot(results_by_group,aes(x=exclude_name,y=auc_improvement,fill=exclude_name))+geom_boxplot()+theme_classic()
ggplot(results_by_group,aes(x=exclude_name,y=auc_improvement,fill=exclude_name))+geom_boxplot()+theme_classic()+theme(axis.text.x = element_text(angle = 90))
ggsave(ggplot(results_by_group,aes(x=exclude_name,y=auc_improvement,fill=exclude_name))+geom_boxplot()+theme_classic()+theme(axis.text.x = element_text(angle = 90)),filename = "auc_improvement_by_group.pdf",width = 6, height = 4)
ggsave(ggplot(results_by_group,aes(x=exclude_name,y=auc_improvement,fill=exclude_name))+geom_boxplot()+theme_classic()+labs(y="AUC Improvement",x="Group",fill="Group")+theme(axis.text.x = element_text(angle = 90)),filename = "auc_improvement_by_group.pdf",width = 6, height = 4)
ggplot(auc_improvement,aes(x=age,y=auc_improvement,fill=age))+geom_boxplot()+theme_classic()+labs(y="AUC Improvement",x="Age")+theme(axis.text.x = element_text(angle = 90)
)
ggplot(auc_improvement,aes(x=age,y=auc_improvement,fill=age))+geom_boxplot()+theme_classic()+labs(y="AUC Improvement",x="Age")+theme(axis.text.x = element_text(angle = 90))
ggplot(results_by_group,aes(x=age,y=auc_improvement,fill=age))+geom_boxplot()+theme_classic()+labs(y="AUC Improvement",x="Age")+theme(axis.text.x = element_text(angle = 90)
)
ggplot(results_by_group,aes(x=age,y=auc_improvement,fill=age,group=age))+geom_boxplot()+theme_classic()+labs(y="AUC Improvement",x="Age")+theme(axis.text.x = element_text(angle = 90)
)
ggplot(results_by_group,aes(x=age,y=auc_improvement,fill=as.factor(age),group=as.factor(age)))+geom_boxplot()+theme_classic()+labs(y="AUC Improvement",x="Age")+theme(axis.text.x = element_text(angle = 90))
ggsave(
ggplot(results_by_group,aes(x=age,y=auc_improvement,fill=as.factor(age),group=as.factor(age)))+geom_boxplot()+theme_classic()+labs(y="AUC Improvement",x="Age",fill="Age")+theme(axis.text.x = element_text(angle = 90))
,filename="auc_improvement_by_age.pdf",width = 6, height = 4)
